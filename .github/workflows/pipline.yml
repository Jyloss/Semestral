name: Secure Deploy WordPress

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted
    timeout-minutes: 10

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Prepare log directory
      run: mkdir -p /home/ubuntu/pipeline-logs/history

    - name: Start deployment log
      run: |
        LOGFILE="/home/ubuntu/pipeline-logs/history/deploy-$(date +"%Y%m%d-%H%M%S").log"
        echo "Deploy iniciado en: $(date)" | tee -a "$LOGFILE"
        echo "Commit: $GITHUB_SHA" | tee -a "$LOGFILE"
        echo "Runner: $(hostname)" | tee -a "$LOGFILE"
        echo "====================================" | tee -a "$LOGFILE"
        echo "$LOGFILE" > /home/ubuntu/pipeline-logs/current_log
      id: startlog

    - name: Load log path
      run: echo "LOGFILE=$(cat /home/ubuntu/pipeline-logs/current_log)" >> $GITHUB_ENV

    - name: Stop containers
      run: |
        docker-compose down || true
        echo "[INFO] Contenedores detenidos" | tee -a "$LOGFILE"

    - name: Pull images
      run: |
        docker-compose pull
        echo "[INFO] Imágenes actualizadas" | tee -a "$LOGFILE"

    - name: Start containers
      run: |
        docker-compose up -d
        echo "[INFO] Nuevos contenedores levantados" | tee -a "$LOGFILE"

    - name: Health check
      run: |
        echo "[INFO] Esperando WordPress..." | tee -a "$LOGFILE"
        sleep 15
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:2000)

        echo "[INFO] HTTP Status: $STATUS" | tee -a "$LOGFILE"

        if [ "$STATUS" != "200" ] && [ "$STATUS" != "301" ] && [ "$STATUS" != "302" ]; then
            echo "[ERROR] WordPress no levantó correctamente" | tee -a "$LOGFILE"
            docker-compose logs | tee -a "$LOGFILE"
            exit 1
        fi

        echo "[OK] WordPress funcionando correctamente" | tee -a "$LOGFILE"

    - name: Mark success log
      if: success()
      run: |
        LOGFILE=$(cat /home/ubuntu/pipeline-logs/current_log)
        cp "$LOGFILE" /home/ubuntu/pipeline-logs/last-success.log
        echo "[OK] Deploy exitoso: $(date)" | tee -a "$LOGFILE"
        rm -f /home/ubuntu/pipeline-logs/last-failure.log

    - name: Mark failure log
      if: failure()
      run: |
        LOGFILE=$(cat /home/ubuntu/pipeline-logs/current_log)
        cp "$LOGFILE" /home/ubuntu/pipeline-logs/last-failure.log
        echo "[FAIL] Deploy falló: $(date)" | tee -a "$LOGFILE"
