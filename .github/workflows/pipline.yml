name: Secure Deploy WordPress

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    timeout-minutes: 10

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Show current runner status
      run: |
        echo "Runner hostname: $(hostname)"
        echo "Current user: $(whoami)"
        docker --version
        docker-compose --version

    # ðŸ” Validar integridad de imÃ¡genes
    - name: Validate WordPress image integrity
      run: |
        echo "Validando integridad de WordPress..."
        docker pull wordpress:latest
        docker image inspect wordpress:latest >/dev/null 2>&1 || exit 1

    - name: Validate MySQL image integrity
      run: |
        echo "Validando integridad de MySQL..."
        docker pull mysql:8.0
        docker image inspect mysql:8.0 >/dev/null 2>&1 || exit 1

    # ðŸ›¡ï¸ Scan de vulnerabilidades (Trivy)
    - name: Security scan with Trivy
      run: |
        docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image wordpress:latest || true
        docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image mysql:8.0 || true

    # ðŸ§¹ Detener cualquier contenedor previo
    - name: Stop existing containers
      run: |
        echo "Deteniendo contenedores previos..."
        docker-compose down || true

    # ðŸ“¦ Pull de imÃ¡genes
    - name: Pull updated images
      run: docker-compose pull

    # ðŸš€ Levantar contenedores
    - name: Start updated containers
      run: docker-compose up -d

    # ðŸ” Verificar salud
    - name: Test service health
      run: |
        echo "Esperando que WordPress arranque..."
        sleep 15

        STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:2000)

        if [ "$STATUS" != "200" ] && [ "$STATUS" != "301" ] && [ "$STATUS" != "302" ]; then
            echo "âŒ WordPress no responde correctamente. CÃ³digo: $STATUS"
            docker-compose logs
            exit 1
        fi

        echo "âœ”ï¸ WordPress estÃ¡ arriba con status: $STATUS"

    # ðŸ”” Enviar alerta en caso de fallo
  notify:
    needs: deploy
    runs-on: self-hosted
    if: failure()

    steps:
    - name: Send failure alert
      run: |
        echo "âš ï¸ Deployment fallÃ³ en $(date)" > fail.txt
        echo "Puedes revisar los logs en GitHub Actions." >> fail.txt

        curl -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer $GITHUB_TOKEN" \
          https://api.github.com/repos/${GITHUB_REPOSITORY}/issues \
          -d '{"title":"ðŸš¨ Deployment Failed","body":"El pipeline fallÃ³. Revisa el Ãºltimo job para mÃ¡s detalles."}'
